<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>data/VideoPlayerTimeStore.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module.html#.exports">exports</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="ProgressBar_ProgressBar.html">ProgressBar</a></li><li><a href="VideoPlayerContainer_VideoPlayerContainer.html">VideoPlayerContainer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ActionMap">ActionMap</a></li><li><a href="global.html#basicTime">basicTime</a></li><li><a href="global.html#BufferRecord">BufferRecord</a></li><li><a href="global.html#calculateClickPosition">calculateClickPosition</a></li><li><a href="global.html#componentDidMount">componentDidMount</a></li><li><a href="global.html#componentWillReceiveProps">componentWillReceiveProps</a></li><li><a href="global.html#componentWillUnmount">componentWillUnmount</a></li><li><a href="global.html#end">end</a></li><li><a href="global.html#findPos">findPos</a></li><li><a href="global.html#getBufferedSections">getBufferedSections</a></li><li><a href="global.html#getEventPosition">getEventPosition</a></li><li><a href="global.html#getIsPlaying">getIsPlaying</a></li><li><a href="global.html#handleChange">handleChange</a></li><li><a href="global.html#handleClick">handleClick</a></li><li><a href="global.html#handleDragStart">handleDragStart</a></li><li><a href="global.html#handleDragStop">handleDragStop</a></li><li><a href="global.html#handleMouseDown">handleMouseDown</a></li><li><a href="global.html#handleMouseEnter">handleMouseEnter</a></li><li><a href="global.html#handleMouseLeave">handleMouseLeave</a></li><li><a href="global.html#handleMouseMove">handleMouseMove</a></li><li><a href="global.html#handleMouseUp">handleMouseUp</a></li><li><a href="global.html#handleStreamInitialized">handleStreamInitialized</a></li><li><a href="global.html#instance">instance</a></li><li><a href="global.html#key">key</a></li><li><a href="global.html#map2QueryString">map2QueryString</a></li><li><a href="global.html#mute">mute</a></li><li><a href="global.html#pause">pause</a></li><li><a href="global.html#play">play</a></li><li><a href="global.html#playbackRate">playbackRate</a></li><li><a href="global.html#queryString2Map">queryString2Map</a></li><li><a href="global.html#removeEventListeners">removeEventListeners</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#retrieveManifest">retrieveManifest</a></li><li><a href="global.html#seek">seek</a></li><li><a href="global.html#seekByMilliseconds">seekByMilliseconds</a></li><li><a href="global.html#seekByPercent">seekByPercent</a></li><li><a href="global.html#setAutoPlay">setAutoPlay</a></li><li><a href="global.html#shouldComponentUpdate">shouldComponentUpdate</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#startOrResetVideoUpdateLoop">startOrResetVideoUpdateLoop</a></li><li><a href="global.html#togglePlay">togglePlay</a></li><li><a href="global.html#unmute">unmute</a></li><li><a href="global.html#updateVideoState">updateVideoState</a></li><li><a href="global.html#video">video</a></li><li><a href="global.html#VideoEventKeys">VideoEventKeys</a></li><li><a href="global.html#VideoPlayerOptions">VideoPlayerOptions</a></li><li><a href="global.html#VideoPlayerState">VideoPlayerState</a></li><li><a href="global.html#VideoPlayerTimeState">VideoPlayerTimeState</a></li><li><a href="global.html#volume">volume</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">data/VideoPlayerTimeStore.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Saves real time state of the video player. Triggers many change events
 */
// External
import {ReduceStore} from 'flux/utils';
import Immutable from 'immutable';
import invariant from 'invariant';
import dispatcher from './VideoDispatcher';
import { Record } from 'immutable';
import Constants from './VideoPlayerConstants';

// Internal
import { getBufferedSections } from '../lib/getVideoState';

function getDashStates(dashPlayer) {
  return {
    duration: dashPlayer.duration(),
    bufferLength: dashPlayer.getBufferLength('video')
  };
}


/**
 * Stores timing info that rapidly changes
 */
export const VideoPlayerTimeState = new Record({
  currentTime: 0,
  duration: 0,
  progress: 0,
  buffered: 0,
  bufferedSections: new Immutable.List(),
  bufferLength: 0
});

/**
 * Actions to take
 */
export const ActionMap = {
  /**
   * Called constantly and only saves timing information so
   * components that need the data that changes frequently
   * can listen to this store while other components can
   * listen to VideoPLayerStore for less frequent updates
   */
  [Constants.updateState]: function update(state, action) {
    const {
      video,
      dashPlayer
    } = action;
    // Video will be a &lt;video /> element except during testing
    invariant(
      typeof video !== 'undefined',
      'action.video is not defined'
    );
    let dashState = {};
    const videoState = {
      currentTime: video.currentTime,
      duration: video.duration,
      progress: (video.currentTime / video.duration) * 100,
      buffered: video.buffered.length > 0 ? (video.buffered.end(video.buffered.length - 1) / video.duration * 100) : 0,
      bufferedSections: getBufferedSections(video)
    };

    // Do nothing when there is no dashPlayer object
    // OR video hasn't been processed yet
    // DashJS API will throw an error "video playback has not initialized yet"
    // when running this function for a video that is in a upload process
    // aka not ready to play
    if (dashPlayer &amp;&amp; dashPlayer.isReady()) {
      dashState = getDashStates(dashPlayer);
    }

    return state.merge(Object.assign(videoState, dashState));
  }
};

export class VideoPlayerTimeStore extends ReduceStore {
  /**
   * Initial
   */
  getInitialState() {
    return new VideoPlayerTimeState({});
  }

  /**
   * Get a value from the record
   * @param {String} key
   */
  get(key) {
    return this._state[key];
  }

  /**
   * Make current time available with get('currentTime')
   */
  get currentTime() {
    return this._state.currentTime;
  }

  /**
   * Handle incoming actions
   * @param {Record} state
   * @param {Object} action
   */
  reduce(state, action) {
    invariant(
      typeof action.type === 'string',
      'action.type is not a string'
    );
    const handler = ActionMap[action.type];
    if (typeof handler === 'function' &amp;&amp; typeof action.type === 'string') {
      const updatedState = handler.call(this, state, action);
      // Verify the state changed otherwise return the original state. This should
      // hopefully reduce some of the updates
      return Immutable.is(updatedState, state) ? state : updatedState;
    }

    return state;
  }
}

/**
 * Create a singleton
 */
const instance = new VideoPlayerTimeStore(dispatcher);
export default instance;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Apr 09 2018 17:08:24 GMT-0700 (PDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
